% CU CS5525
% Fall 2012
% Python Compiler
%
% slides.tex
% Semester Project Slides
%
% Repository:
%    https://github.com/asayler/CU-CS5525-PythonCompiler
%
% By :
%    Anne Gatchell
%       http://annegatchell.com/
%    Andy Sayler
%       http://www.andysayler.com
%    Michael (Mike) Vitousek
%       http://csel.cs.colorado.edu/~mivi2269/

\documentclass{beamer}
\usetheme{AnnArbor}
\usecolortheme{beaver}
\setbeamercovered{transparent=25}
\setbeamertemplate{blocks}[rounded][shadow=false]
\setbeamertemplate{navigation symbols}{}
\setcounter{tocdepth}{1}

\usepackage{graphicx}
\usepackage{url}
\usepackage{listings}
\usepackage{biblatex}
\usepackage{amssymb}
\bibliography{refs}

\hypersetup{
    colorlinks,
    citecolor=black,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}

\lstset{
  language={},
  basicstyle=\footnotesize,
  numbers=none,
  numberstyle=\tiny,
  stepnumber=1,
  numbersep=5pt,
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  tabsize=4,
  captionpos=b,
  breaklines=true,
  breakatwhitespace=false,
  frame=single,
  frameround=tttt
}

\lstdefinelanguage{llvm}{
  morecomment = [l]{;},
  morestring=[b]'', 
  sensitive = true,
  classoffset=0,
  morekeywords={
    define, declare, global, constant,
    internal, external, private,
    linkonce, linkonce_odr, weak, weak_odr, appending,
    common, extern_weak,
    thread_local, dllimport, dllexport,
    hidden, protected, default,
    except, deplibs,
    volatile, fastcc, coldcc, cc, ccc,
    x86_stdcallcc, x86_fastcallcc,
    ptx_kernel, ptx_device,
    signext, zeroext, inreg, sret, nounwind, noreturn,
    nocapture, byval, nest, readnone, readonly, noalias, uwtable,
    inlinehint, noinline, alwaysinline, optsize, ssp, sspreq,
    noredzone, noimplicitfloat, naked, alignstack,
    module, asm, align, tail, to,
    addrspace, section, alias, sideeffect, c, gc,
    target, datalayout, triple,
    blockaddress
  },
  classoffset=1,
  morekeywords={
    fadd, sub, fsub, mul, fmul,
    sdiv, udiv, fdiv, srem, urem, frem,
    and, or, xor,
    icmp, fcmp,
    eq, ne, ugt, uge, ult, ule, sgt, sge, slt, sle,
    oeq, ogt, oge, olt, ole, one, ord, ueq, ugt, uge,
    ult, ule, une, uno,
    nuw, nsw, exact, inbounds,
    phi, call, select, shl, lshr, ashr, va_arg,
    trunc, zext, sext,
    fptrunc, fpext, fptoui, fptosi, uitofp, sitofp,
    ptrtoint, inttoptr, bitcast,
    ret, br, indirectbr, switch, invoke, unwind, unreachable,
    malloc, alloca, free, load, store, getelementptr,
    extractelement, insertelement, shufflevector,
    extractvalue, insertvalue,
  },
  alsoletter={\%},
  keywordsprefix={\%},
}

\newenvironment{packed_enum}{
\begin{enumerate}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}{\end{enumerate}}

\newenvironment{packed_item}{
\begin{itemize}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}{\end{itemize}}

\title[LLVM Compiler]{
  Building a LLVM Python Compiler
}

\author[Gatchell, Sayler, Vitousek]{
  Anne Gatchell    \and
  Andy Sayler      \and
  Michael Vitousek
}

\institute[CU Boulder]{
  University of Colorado at Boulder   \\
  \texttt{anne.gatchell@colorado.edu} \\
  \texttt{andrew.sayler@colorado.edu} \\
  \texttt{michael.vitousek@colorado.edu}
}

\date{\today}

\begin{document}

%---Title Slide---%
\begin{frame}[plain]
  \titlepage
\end{frame}

%---TOC Slide---%
\begin{frame}{Outline}
  \tableofcontents
\end{frame}

\section{Introduction}

%---Goals Slide---%
\begin{frame}{\bf Goals}
  \begin{itemize}
  \item<1-> Create Low Level Virtual Machine (LLVM) p3-compliant compiler
  \item<2-> Compare to x86 compiler
  \item<3-> Test on multiple architectures(x86, ARM, etc.)
  \end{itemize}
\end{frame}

%---Background Slide---%
\begin{frame}{\bf Background: LLVM}
  \begin{itemize}
  \item<1->Open source
  \item<2->Static Single Assembly (SSA)
  \item<3->Multi-platform support
  \item<4->Multi-runtime support (compiled, interpreted, JIT, etc.)
  \end{itemize}
\end{frame}

%---LLVM Slide---%
\begin{frame}{\bf LLVM}
  \begin{itemize}
  \item<1->LLVM Intermediate Representation(IR)
  \begin{itemize}
  \item<1->In-memory data structure
  \item<2->Human readable ``assembly'' language (.ll)
  \item<3->File-oriented bitcode (colloqially, bytecode) (.bc)
  \end{itemize}
  \item<2->We convert to assemble (.ll) code
  \item<3->Example...
  \end{itemize}
\end{frame}

%---LLVM Hello World Slide---%
\begin{frame}{\bf LLVM ``Hello World''}
  \lstinputlisting[
    language=llvm,
    title={LLVM Assembly - Hello World Example \cite{lattner-llvmlangref}}
  ]{../code/llvm-examples/hello0.ll}
\end{frame}

%---SSA---%
\begin{frame}{Static Single Assignment Form}
  \begin{itemize}
  \item<1->Each variable assigned only once
  \item<2->If branching involved, use phi nodes
  \item<3->LLVM has phi node already integrated
  \end{itemize}
\end{frame}

\section{Design}

\subsection{Module Flow}

\subsection{SSA Conversion}

\begin{frame}{\bf Simple conversion}
  \lstinputlisting[
  language=python,
  label=lst:ssa-step1,
]{include/py/ssa-step1.py}
\pause
  \lstinputlisting[
  language=python,
  label=lst:ssa-step2,
]{include/py/ssa-step2.py}
\end{frame}

\begin{frame}{Approach and Design}
  \begin{itemize}
  \item<1->"Compiled" tests programs by hand to LLVM IR
  \item<2->Ran assembly
  \item<3->Refactored existing compiler
  \item<4->Added an SSA conversion pass after Flatten pass
  \item<5->Added an LLVM Instruction Selection pass to produce LLVM IR
  \item<6->Modified build and test system to handle both x86 and LLVM
  \item<7->Testing compares Python, x86, and LLVM execution
  \item<8->Compiler pass to add support for Python2.7+ parser
  \end{itemize}
\end{frame}


%---Module Flow Slide---%
\begin{frame}{\bf Module Flow}
  \begin{center}
    \includegraphics[height=.75\paperheight]{./include/CompilerFlow.pdf}
  \end{center}
\end{frame}

\begin{frame}[shrink]{\bf SSA Conversions of If statements}
  \lstinputlisting[
  language=python,
  label=lst:ssa-if1,
]{include/py/ssa-if1.py}
\pause
  \lstinputlisting[
  language=python,
  label=lst:ssa-if2,
]{include/py/ssa-if2.py}
\end{frame}

\begin{frame}[shrink]{\bf SSA Conversions of While statements}
  \lstinputlisting[
  language=python,
  label=lst:ssa-while1,
]{include/py/ssa-while1.py}
\pause
  \lstinputlisting[
  language=python,
  label=lst:ssa-while2,
]{include/py/ssa-while2.py}
\end{frame}

\begin{frame}{LLVM Instructions}
  \begin{itemize}
  \item<1->LLVM is higher level than x86 -> more features
    \begin{itemize}
    \item<1->Keep track of register types
    \item<2->Lucky: Pyobj pointers
    \item<3->External functions must be Declared
    \item<4-> \%x = 5 is not allowed, why?
    \item<5->Use internal constants:
    \item<6->@1 = constant i32 5 #at top of file
    \item<7->\%x = load i32* @V1 #loaded pointer to the constant 
    \end{itemize}
  \end{itemize}

\subsection{LLVM Build Process}

\section{Results}


\section{Discussion}

\section{Conclusion}

%---Bibliography Slide---%
\begin{frame}[t,allowframebreaks]{\bf Bibliography}
  \nocite{*}
  \printbibliography
\end{frame}

\end{document}
